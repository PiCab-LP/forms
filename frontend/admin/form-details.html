<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Details - Wysaro Admin</title>
    <link rel="icon" type="image/x-icon" href="../imgs/wysaro-isologo-black.png">
    <link rel="stylesheet" href="/admin/css/admin.css">

    <style>
        .details-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .back-button:hover { background: #764ba2; }

        .details-header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }

        .details-header h1 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .details-meta {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            color: #666;
            font-size: 14px;
        }

        .details-meta div {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }

        .section h2 {
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .info-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .info-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .info-value {
            font-size: 16px;
            color: #333;
            word-break: break-word;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .gallery-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #eee;
            background: #fff;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .gallery-item:hover { transform: scale(1.05); }
        .gallery-item img { width: 100%; height: 150px; object-fit: contain; padding: 10px; }

        .logo-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .badge-has { background: #e3f2fd; color: #1976d2; }
        .badge-needs { background: #fff3e0; color: #f57c00; }

        .manager-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            margin-bottom: 15px;
        }

        .manager-card h3 { color: #667eea; margin-bottom: 15px; }

        .version-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #28a745;
        }

        .version-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .version-number { font-weight: 600; color: #667eea; }
        .version-date { color: #666; font-size: 14px; }

        .changes-list {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }

        .change-item {
            font-size: 13px;
            color: #666;
            margin-bottom: 5px;
        }

        .loading-spinner {
            text-align: center;
            padding: 60px;
            color: #999;
        }

        .action-bar { display: flex; gap: 15px; margin-top: 20px; }

        .btn-action {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-edit { background: #667eea; color: white; }
        .btn-edit:hover { background: #764ba2; }
        .btn-delete-detail { background: #dc3545; color: white; }
        .btn-delete-detail:hover { background: #c82333; }
    </style>
</head>
<body>
    <div class="details-container">
        <a href="/admin/" class="back-button"> ‚Üê Back to Dashboard </a>

        <div id="loadingSpinner" class="loading-spinner"> Loading form details... </div>

        <div id="formDetails" style="display: none;">
            <div class="details-header">
                <h1 id="companyName">Loading...</h1>
                <div class="details-meta">
                    <div>üìß <span id="email">-</span></div>
                    <div>üìÖ Created: <span id="createdAt">-</span></div>
                    <div>‚úèÔ∏è Edits: <span id="editCount">-</span></div>
                    <div>üìÑ Version: <span id="currentVersion">-</span></div>
                </div>
                <div class="action-bar">
                    <button class="btn-action btn-edit" onclick="editForm()">‚úèÔ∏è Edit Form</button>
                    <button class="btn-action btn-delete-detail" onclick="deleteFormDetail()">üóëÔ∏è Delete Form</button>
                </div>
            </div>

            <div class="section">
                <h2>üìù Room Operational Details</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Daily Cashout Limit</div>
                        <div class="info-value" id="cashoutLimit">$ -</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Minimum Deposit</div>
                        <div class="info-value" id="minDeposit">$ -</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Cashout Schedule</div>
                        <div class="info-value" id="roomSchedule">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Telegram Support Number</div>
                        <div class="info-value" id="telegramPhone">-</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>üé® Logo & Branding Identity</h2>
                <div id="logoIdentitySection"></div>
            </div>

            <div class="section">
                <h2>üåê Social Networks</h2>
                <div class="info-grid" id="socialNetworks"></div>
            </div>

            <div class="section">
                <h2>üë• Backend Managers</h2>
                <div id="managers"></div>
            </div>

            <div class="section">
                <h2>üìã Version History</h2>
                <div id="versionHistory"></div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://forms-wliu.onrender.com/api/admin';
        let currentToken = '';
        let formData = null;

        function checkAuth() {
            const jwtToken = localStorage.getItem('adminToken');
            if (!jwtToken) {
                window.location.href = '/login.html';
                return false;
            }
            return true;
        }

        const urlParams = new URLSearchParams(window.location.search);
        currentToken = urlParams.get('token');

        window.addEventListener('DOMContentLoaded', () => {
            if (!checkAuth()) return;
            if (!currentToken) {
                alert('No token provided');
                window.location.href = '/admin';
                return;
            }
            loadFormDetails();
        });

        async function loadFormDetails() {
            try {
                const jwtToken = localStorage.getItem('adminToken');
                const response = await fetch(`${API_URL}/forms/${currentToken}`, {
                    headers: { 'Authorization': `Bearer ${jwtToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    formData = data.data;
                    renderFormDetails(formData);
                    document.getElementById('loadingSpinner').style.display = 'none';
                    document.getElementById('formDetails').style.display = 'block';
                } else {
                    alert('Form not found');
                    window.location.href = '/admin';
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error loading form details');
            }
        }

        function renderFormDetails(form) {
            const p1 = form.formData?.page1 || {};
            
            // Header
            document.getElementById('companyName').textContent = p1.companyName || 'N/A';
            document.getElementById('email').textContent = form.email;
            document.getElementById('createdAt').textContent = new Date(form.createdAt).toLocaleString();
            document.getElementById('editCount').textContent = form.editCount;
            document.getElementById('currentVersion').textContent = form.currentVersion;

            // üî• RENDER ROOM DETAILS
            document.getElementById('cashoutLimit').textContent = p1.cashoutLimit ? `$${p1.cashoutLimit}` : 'Not set';
            document.getElementById('minDeposit').textContent = p1.minDeposit ? `$${p1.minDeposit}` : 'Not set';
            document.getElementById('telegramPhone').textContent = p1.telegramPhone ? `+1 ${p1.telegramPhone}` : 'No number provided';
            
            const scheduleBox = document.getElementById('roomSchedule');
            if (p1.scheduleOption === '24/7') {
                scheduleBox.innerHTML = '<span style="color: #28a745; font-weight: bold;">üü¢ 24/7 Available</span>';
            } else {
                scheduleBox.textContent = p1.customSchedule || 'No schedule provided';
            }

            // Logos
            const logoDiv = document.getElementById('logoIdentitySection');
            let logoHTML = '';
            if (p1.logoOption === 'has-logo') {
                logoHTML = `<div class="logo-badge badge-has">Existing Logo Provided</div><div class="gallery-grid">${p1.uploadedLogos?.map(url => `<div class="gallery-item" onclick="window.open('${url}', '_blank')"><img src="${url}"></div>`).join('') || '<p>No images</p>'}</div>`;
            } else if (p1.logoOption === 'needs-logo') {
                logoHTML = `<div class="logo-badge badge-needs">Needs Logo Creation</div><div class="info-item"><div class="info-label">Instructions</div><div class="info-value">${p1.designReferenceText || 'N/A'}</div></div><div class="gallery-grid">${p1.designReferenceImages?.map(url => `<div class="gallery-item" onclick="window.open('${url}', '_blank')"><img src="${url}"></div>`).join('') || '<p>No images</p>'}</div>`;
            } else {
                logoHTML = '<p style="color: #999;">No logo preference selected.</p>';
            }
            logoDiv.innerHTML = logoHTML;

            // Socials
            const socialNetworksDiv = document.getElementById('socialNetworks');
            let socialHTML = '';
            ['facebook', 'instagram', 'twitter', 'other'].forEach(s => {
                if (p1[s]) socialHTML += `<div class="info-item"><div class="info-label">${s}</div><div class="info-value"><a href="${p1[s]}" target="_blank">${p1[s]}</a></div></div>`;
            });
            socialNetworksDiv.innerHTML = socialHTML || '<p style="color: #999;">No social networks provided</p>';

            // Managers
            const managers = form.formData?.page2?.managers || [];
            document.getElementById('managers').innerHTML = managers.length > 0 ? managers.map((m, i) => `
                <div class="manager-card">
                    <h3>Manager #${i + 1}</h3>
                    <div class="info-grid">
                        <div class="info-item"><div class="info-label">Username</div><div class="info-value">${m.username}</div></div>
                        <div class="info-item"><div class="info-label">Full Name</div><div class="info-value">${m.fullname}</div></div>
                        <div class="info-item"><div class="info-label">Role</div><div class="info-value">${m.role}</div></div>
                        <div class="info-item"><div class="info-label">Email</div><div class="info-value">${m.email}</div></div>
                        <div class="info-item"><div class="info-label">Password</div><div class="info-value"><code>${m.password}</code></div></div>
                    </div>
                </div>`).join('') : '<p style="color: #999;">No managers added</p>';

            // History
            const versions = form.versions || [];
            document.getElementById('versionHistory').innerHTML = versions.length > 0 ? [...versions].reverse().map(v => `
                <div class="version-item">
                    <div class="version-header">
                        <span class="version-number">Version ${v.versionNumber}</span>
                        <span class="version-date">${new Date(v.editedAt).toLocaleString()}</span>
                    </div>
                    ${v.changes ? `<div class="changes-list">${Object.entries(v.changes).map(([k, c]) => `<div class="change-item">‚Ä¢ ${k}: <span style="color: #dc3545;">${c.old || 'empty'}</span> ‚Üí <span style="color: #28a745;">${c.new || 'empty'}</span></div>`).join('')}</div>` : '<div class="changes-list"><em>Initial submission</em></div>'}
                </div>`).join('') : '<p style="color: #999;">No history</p>';
        }

        function editForm() { window.open(`${window.location.origin}/?token=${currentToken}`, '_blank'); }
        async function deleteFormDetail() {
            if (!confirm('Are you sure?')) return;
            const response = await fetch(`${API_URL}/forms/${currentToken}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${localStorage.getItem('adminToken')}` }
            });
            if ((await response.json()).success) { alert('Deleted'); window.location.href = '/admin'; }
        }
    </script>
</body>
</html>